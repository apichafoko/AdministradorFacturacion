@{
    ViewData["Title"] = "Subir Archivo Excel";

}

@model IndexViewModel


<h2>¡Bienvenido!</h2>

<form asp-action="Index" asp-controller="Home" enctype="multipart/form-data" method="post">
    <div class="container-fluid mt-4">
    <div class="row">
        <div class="col-lg-12 col-md-12 mb-4">
            <div class="card shadow-sm rounded border-light" style="border-radius: .55rem">
                <div class="card-body">
                    <h5 class="card-title text-center">Subir archivo Excel</h5>
                    <p class="card-text" style="font-style: italic; text-align: center;">
                        El sistema funciona procesando el archivo excel que se descarga de la sección <u>"Estadística de Boletas"</u> y siguiendo estos 4 pasos.
                    </p>
                    <p class="card-text" style="text-align: left;">
                        <br>Paso 1) Descargar el archivo Excel de la sección <u>"Estadística de Boletas"</u> de la página del portal.
                        <br>Paso 2) Subir el archivo Excel descargado (.xls) en el paso 1 al sitio <a href="https://cloudconvert.com/xls-to-xlsx">Cloud Convert</a>
                        <br>Paso 3) Convertir el archivo .XLS a la extension .XLSX
                        <br><b>Paso 4) Subir el archivo .XLSX a esta aplicación.</b>
                    </p>
                    <p>
                        <u>Importante:</u> El archivo Excel debe ser subido en formato .XLSX. Si no se sube en este formato, el sistema no podrá procesar la información.
                    </p>
                    <p>
                        <b>Nota:</b> <i>Su información no es almacenada en ningún lado. Cuando cierre el explorador se perderá toda la información y  deberá volver a cargar el archivo cada vez que entre.</i>
                    </p>
                    <form enctype="multipart/form-data" method="post" action="/subirArchivo">
                        <div class="form-group mb-3">
                            <label for="file" class="form-label">Seleccionar archivo Excel:</label>
                            <input type="file" name="file" class="form-control" accept=".xlsx" required />
                        </div>
                        <div class="d-grid gap-2">
                            <button type="submit" class="btn" style="background-color: #5499C7; color: white; border-color: #2980B9;">Subir</button>
                        </div>
                        <div class="mt-3">
                            @if (ViewBag.Message != null)
                                {
                                        <div class="alert alert-info">
                                        @ViewBag.Message
                                        </div>
                                }                 
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>


</form>

@if (Model.ListadoBoletas.Count() > 0)
{
<div class="tabs-container">
    <ul class="tabs-list">
        <li class="tab active" data-tab="tab-1">Datos Históricos</li>
        <li class="tab" data-tab="tab-2">Datos generales por período</li>
        @if(Model.SaldosHistoricosPublicos != null)
        {
            <li class="tab" data-tab="tab-3">Público</li>
        }
        @if(Model.SaldosHistoricosPrivados != null)
        {
        <li class="tab" data-tab="tab-4">Privado</li>
        }
        <li class="tab" data-tab="tab-5">Detalle Boletas</li>
    </ul>

    <div class="tabs-content">
        <!-- Tab 1: Datos Generales -->
        <div class="tab-content active" id="tab-1">
            <h2>Datos Generales Históricos</h2>
            <div class="container-fluid mt-4">
                    <div class="row">
                        <div class="col-lg-12 col-md-6 mb-4">
                            <div class="card shadow-sm rounded border-light style="border-radius: .55rem">
                                <div class="card-body">
                                    <p class="card-text" style="font-style: italic;text-align: center;">
                                        Esta sección muestra los datos históricos de tu facturación. Toma en cuenta toda las boletas presentes en el archivo Excel.
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <!-- Tarjeta 1 -->
                        <div class="col-lg-3 col-md-6 mb-4">
                            <div class="card text-center shadow-sm">
                                <div class="card-body">
                                    <h2 class="card-title display-4 text-primary"><span style="color: black;">@Model.CantidadBoletasProceadas</span></h2>
                                    <p class="card-text">¿Cuántas boletas se procesaron?</p>
                                </div>
                            </div>
                        </div>
                        <!-- Tarjeta 2 -->
                        <div class="col-lg-3 col-md-6 mb-4">
                            <div class="card text-center shadow-sm">
                                <div class="card-body">
                                    <h2 class="card-title display-4 text-primary"><span style="color: black;">@Model.CantidadBoletasConPagos</span></h2>
                                    <p class="card-text">¿Cuántas boletas recibieron algún pago?</p>
                                </div>
                            </div>
                        </div>
                        <!-- Gráfico -->
                        <div class="col-lg-6 col-md-12 mb-4">
                            <div class="card shadow-sm">
                                <div class="card-body">
                                    <h5 class="card-title">¿Qué día de la semana tengo más boletas? (Histórico)</h5>
                                    <div>
                                        <canvas id="graficoBoletas"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <!-- Gráfico -->
                        <div class="col-lg-12 col-md-12 mb-4">
                            <div class="card shadow-sm">
                                <div class="card-body">
                                    <h5 class="card-title">Facturación histórica</h5>
                                        <div id="graficoFacturacionHistorica" style="height: 400px; width: 100%;"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-lg-12 col-md-6 mb-4">
                            <div class="card shadow-sm rounded border-light style="border-radius: .55rem">
                                <div class="card-body">
                                    <p class="card-text" style="font-style: italic;text-align: center;">
                                        El valor del dólar blue esta calculado como el promedio del valor del dolar blue mensual. Se tienen en cuenta el valor de cada día del mes y se calcula el promedio.
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <!-- Gráfico -->
                        <div class="col-lg-12 col-md-12 mb-4">
                            <div class="card shadow-sm">
                                <div class="card-body">
                                    <h5 class="card-title">Facturación historica en USD (blue)</h5>
                                        <div id="graficoFacturacionHistoricaUSD" style="height: 400px; width: 100%;"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <!-- Gráfico -->
                        <div class="col-lg-12 col-md-12 mb-4">
                            <div class="card shadow-sm">
                                <div class="card-body">
                                        <div id="graficoEdadPacientes" style="height: 400px; width: 100%;"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                     <div class="row">
                        <!-- Gráfico -->
                        <div class="col-lg-12 col-md-12 mb-4">
                            <div class="card shadow-sm">
                                <div class="card-body">
                                    <canvas id="graficosBoletasEntidadGeneral"></canvas>

                                </div>
                            </div>
                        </div>
                    </div>
                </div>
        </div>

        <!-- Tab 2: Ultimo Periodo -->
        <div class="tab-content" id="tab-2">
            <h2>Datos generales por período</h2>
            <div class="container-fluid mt-4">
                <!-- Dropdown para seleccionar período -->
            <div class="row mb-3">
                <div class="col-lg-4 col-md-6">
                    <label for="periodSelector" class="form-label">Seleccionar Período</label>
                    <select id="periodSelector" class="form-select">
                        @foreach (var item in Model.PeriodosDisponibles)
                        {
                            <option value="@item">@item</option>
                        }
                        
                    </select>
                </div>
            </div>
            <div id="resultContainer" >
            <div class="row">
                        <div class="col-lg-12 col-md-6 mb-4">
                            <div class="card shadow-sm rounded border-light style="border-radius: .55rem">
                                <div class="card-body">
                                    <p class="card-text" style="font-style: italic;text-align: center;">
                                        Esta sección muestra los datos tanto del sistema público como privado de tu facturación. <b><u>Esta sección toma en cuenta solo las boletas del último período del Excel.</u></b> 
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                        <div class="row">
                            <!-- Tarjeta 1 -->
                            <div class="col-lg-6 col-md-6 mb-4">
                                <div class="card text-center shadow-sm">
                                    <div class="card-body">
                                        <h2 class="card-title display-4 text-primary"><span style="color: #9B59B6;">@Model.LastYear - @Model.LastPeriod</span></h2>
                                        <p class="card-text">Último Período procesado</p>
                                    </div>
                                </div>
                            </div>
                             <!-- Gráfico -->
                            <div class="col-lg-6 col-md-12 mb-4">
                                <div class="card shadow-sm">
                                    <div class="card-body">
                                        <h5 class="card-title">¿Qué día de la semana del período tuve más boletas?</h5>
                                        <div>
                                            <canvas id="graficoBoletaslastperiod"></canvas>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <!-- Tarjeta 1 -->
                            <div class="col-lg-6 col-md-12 mb-4">
                                <div class="card text-center shadow-sm">
                                    <div class="card-body">
                                        <h2 class="card-title display-4 text-primary">@Model.CantidadBoletasPublicas</h2>
                                        <p class="card-text">¿Cuántas boletas fueron del sistema público?</p>
                                    </div>
                                </div>
                            </div>
                            <!-- Tarjeta 2 -->
                            <div class="col-lg-6 col-md-12 mb-4">
                                <div class="card text-center shadow-sm">
                                    <div class="card-body">
                                        <h2 class="card-title display-4 text-primary"><span style="color: #27AE60;">@Model.CantidadBoletasPrivadas</span></h2>
                                        <p class="card-text">¿Cuántas boletas fueron del sistema privado?</p>
                                    </div>
                                </div>
                            </div>
                            </div>
                            <div class="row">
                            <!-- Tarjeta 1 -->
                            <div class="col-lg-6 col-md-12 mb-4">
                                <div class="card text-center shadow-sm">
                                    <div class="card-body">
                                        <h2 class="card-title display-4 text-primary">$ @String.Format("{0:N2}", (Model.IngresosMensualesPublico?.Last().Value ?? 0))</h2> 
                                        <p class="card-text">Facturación bruta público</p>
                                    </div>
                                </div>
                            </div>
                            <!-- Tarjeta 2 -->
                            <div class="col-lg-6 col-md-12 mb-4">
                                <div class="card text-center shadow-sm">
                                    <div class="card-body">
                                        <h2 class="card-title display-4 text-primary"><span style="color: #27AE60;"> $ @String.Format("{0:N2}", (Model.IngresosMensualesPrivados?.Last().Value ?? 0))</span></h2>
                                        <p class="card-text">Facturación bruta privado</p>
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                            <!-- Tarjeta 1 -->
                            <div class="col-lg-6 col-md-12 mb-4">
                                <div class="card text-center shadow-sm">
                                    <div class="card-body">
                                        <h2 class="card-title display-4 text-primary"><span style="color: #9B59B6;">$ @String.Format("{0:N2}", Model.CotizacionUSDLast)</span></h2> 
                                        <p class="card-text">Cotización dolar blue promedio del mes <b>@Model.LastPeriod - @Model.LastYear</b></p>
                                    </div>
                                </div>
                            </div>
                            <!-- Tarjeta 2 -->
                            <div class="col-lg-6 col-md-12 mb-4">
                                <div class="card text-center shadow-sm">
                                    <div class="card-body">
                                        <h2 class="card-title display-4 text-primary"><span style="color: #9B59B6;"> $ @String.Format("{0:N2}", (Model.IngresosTotalesUSD?.FirstOrDefault().Value ?? 0))</span></h2>
                                        <p class="card-text">Facturación bruta total en USD</p>
                                    </div>
                                </div>
                            </div>
                            </div>
                        </div>
                         <div class="row">
                        <!-- Gráfico -->
                            <div class="col-lg-12 col-md-12 mb-4">
                                <div class="card shadow-sm">
                                    <div class="card-body">
                                            <canvas id="graficosBoletasEntidadLastPeriod"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
            </div>
            </div>
        </div>

       

        @if(Model.SaldosHistoricosPublicos != null)
        {
        <!-- Tab 3: Público -->
        <div class="tab-content" id="tab-3">
            <h2>Público</h2>
            <div class="container-fluid mt-4">
                 <div class="row">
                        <div class="col-lg-12 col-md-6 mb-4">
                            <div class="card shadow-sm rounded border-light style="border-radius: .55rem">
                                <div class="card-body">
                                    <p class="card-text" style="font-style: italic;text-align: center;">
                                        Esta sección muestra <b>solamente las boletas del sistema público </b> presentes en el archivo Excel. Para un correcto funcionamiento <u>baja el Excel y cargalo después del día 15 del mes</u>.
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                        <div class="row">
                            <!-- Tarjeta 1 -->
                            <div class="col-lg-4 col-md-6 mb-4">
                                <div class="card text-center shadow-sm">
                                    <div class="card-body">
                                        <h2 class="card-title display-4 text-primary">@Model.LastYear - @Model.LastPeriod</h2>
                                        <p class="card-text">Último período procesado</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-lg-4 col-md-6 mb-4">
                                <div class="card text-center shadow-sm">
                                    <div class="card-body">
                                        <h2 class="card-title display-4 text-primary">@Model.CantidadBoletasPublicas</h2>
                                        <p class="card-text">Cantidad de boletas públicas</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-lg-4 col-md-6 mb-4">
                                <div class="card shadow-sm">
                                    <div class="card-body">
                                        <h5 class="card-title">¿Qué día de la semana trabaje más en el sistema público? (Último Período)</h5>
                                        <div>
                                            <canvas id="graficoBoletasPublico"></canvas>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="row"> <!-- Tarjeta 1 --> 
                            <div class="col-lg-6 col-md-6 mb-4"> 
                                <div class="card text-center shadow-sm"> 
                                    <div class="card-body"> 
                                        <h2 class="card-title display-4 text-primary">$ @String.Format("{0:N2}", @Model.IngresoPromedioUltimoBrutoPublico)</h2> 
                                        <p class="card-text">Facturación bruta del último período <b>(@Model.LastPeriod - @Model.LastYear)</b></p> 
                                    </div> 
                                </div> 
                            </div> <!-- Tarjeta 2 --> 
                            <div class="col-lg-6 col-md-6 mb-4"> 
                                <div class="card text-center shadow-sm"> 
                                    <div class="card-body"> 
                                        <h2 class="card-title display-4 text-primary">$ @String.Format("{0:N2}", @Model.PromedioBoletaUltimoMesPublico)</h2> 
                                        <p class="card-text">Boleta promedio último período <b>(@Model.LastPeriod - @Model.LastYear)</b></p> 
                                    </div> 
                                </div> 
                            </div> 
                        </div>
                        <div class="row"> <!-- Tarjeta 3 --> 
                            <div class="col-lg-6 col-md-6 mb-4"> 
                                <div class="card text-center shadow-sm"> 
                                    <div class="card-body"> 
                                        <h2 class="card-title display-4 text-primary">$ @String.Format("{0:N2}", @Model.BoletaMayorValorU3MPublico)</h2> 
                                        <p class="card-text">Boleta de mayor valor del Último Período <b>(@Model.LastPeriod - @Model.LastYear)</b></p> 
                                    </div> 
                                </div> 
                            </div> 
                            <div class="col-lg-6 col-md-6 mb-4">
                                <div class="card text-center shadow-sm"> 
                                    <div class="card-body"> <h2 class="card-title display-4 text-primary">$ @String.Format("{0:N2}", @Model.BoletaMenorValorU3MPublico)</h2> 
                                        <p class="card-text">Boleta de menor valor del último período <b>(@Model.LastPeriod - @Model.LastYear)</b></p> 
                                    </div> 
                                </div>
                            </div> 
                        </div>
                       
                        <div class="row">
                            <div class="col-lg-12 col-md-12 mb-4">
                                <div class="card">
                                    <div class="card-body">
                                        <canvas id="graficoIngresos"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-lg-12 col-md-12 mb-4">
                                <div class="card">
                                    <div class="card-body">
                                        <canvas id="graficoCantidadMesPublicas"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                         <!-- Gráfico -->
                        <div class="col-lg-12 col-md-12 mb-4">
                            <div class="card shadow-sm">
                                <div class="card-body" style="width: 100%;">
                                    <canvas id="graficoMutuales"></canvas>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-lg-12 col-md-6 mb-4">
                                <div class="card shadow-sm rounded border-light style="border-radius: .55rem">
                                    <div class="card-body">
                                        <p class="card-text" style="font-style: italic;text-align: center;">
                                        Esta tabla muestra el impote facturado, cobrado y debitado por cada período del archivo Excel. 
                                        Si hay saldo a favor o en contra se muestra en la columna "Diferencia". La diferencia de saldos puede deberse a refacturaciones.
                                        </p>
                                </div>
                            </div>
                        </div>
                    </div>
                        <div class="row">
                            <div class="col-lg-12 col-md-12 mb-4">
                                <h3 class="mb-4">Saldos Mensuales</h3>
                                <div class="table-responsive">
                                    <table id="tablaSaldosMensualesPublicos" class="table table-bordered table-hover align-middle display nowrap" style="width:100%">
                                        <thead class="table-light">
                                            <tr>
                                                <th>Periodo</th>
                                                <th>Porcentaje del total abonado</th>
                                                <th>Diferencia</th>
                                                <th>Importe Facturado (Bruto)</th>
                                                <th>Importe Debitado (Bruto)</th>
                                                <th>Importe Abonado (Bruto)</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            @foreach (var item in Model.SaldosHistoricosPublicos.OrderByDescending(s => DateTime.Parse(s.Periodo)).ToList())
                                            {
                                                <tr>
                                                    <td>@item.Periodo</td>
                                                    <td>
                                                        <div class="d-flex align-items-center">
                                                            <span>@String.Format("{0:N2}%", item.PorcentajeCobrado)</span>
                                                            <div class="progress ms-2 w-100" style="height: 20px;">
                                                                <div class="progress-bar" role="progressbar" style="width: @item.PorcentajeCobrado.ToString("N0")%;" aria-valuenow="@item.PorcentajeCobrado" aria-valuemin="0" aria-valuemax="100"></div>
                                                            </div>
                                                        </div>
                                                    </td>
                                                    <td>
                                                        @{
                                                            var importePendiente = item.ImportePendiente;
                                                            var formattedImportePendiente = Math.Round(importePendiente) == 0 
                                                                ? String.Format("{0:C}", importePendiente)
                                                                : (importePendiente < 0 
                                                                    ? "+" + String.Format(new System.Globalization.CultureInfo("es-AR"),"{0:C}", Math.Abs(importePendiente)) 
                                                                    : "-" + String.Format(new System.Globalization.CultureInfo("es-AR"),"{0:C}", importePendiente));
                                                        }
                                                        @formattedImportePendiente
                                                    </td>
                                                    <td>@String.Format(new System.Globalization.CultureInfo("es-AR"),"{0:C}", item.ImporteFacturadoBruto)</td>
                                                    <td>@String.Format(new System.Globalization.CultureInfo("es-AR"),"{0:C}", item.ImporteDebitadoBruto)</td>
                                                    <td>@String.Format(new System.Globalization.CultureInfo("es-AR"),"{0:C}", item.ImporteCobradoBruto)</td>
                                                </tr>
                                            }
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-lg-12 col-md-6 mb-4">
                                <div class="card shadow-sm rounded border-light style="border-radius: .55rem">
                                    <div class="card-body">
                                        <p class="card-text" style="font-style: italic;text-align: center;">
                                                                                Este gráfico se realiza calculando el importe que deberias recibir en los meses siguientes en base al tiempo promedio que tardan las mutuales en realizar los depositos de pago.
                                        </p>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <!-- Gráfico -->
                             <div class="col-lg-12 col-md-12 mb-4">
                                <div class="card shadow-sm">
                                     <div class="card-body" style="width: 100%;">
                                        <canvas id="graficoMontosCobrar"></canvas>
                                    </div>
                                </div>
                            </div>
                
                        </div>
                    </div>
            </div>
        </div>
        }

        @if(Model.SaldosHistoricosPrivados != null)
        {
        <!-- Tab 4: Privado -->
        <div class="tab-content" id="tab-4">
            <h2>Privado</h2>
            <div class="container-fluid mt-4">
                <div class="row">
                        <div class="col-lg-12 col-md-6 mb-4">
                            <div class="card shadow-sm rounded border-light style="border-radius: .55rem">
                                <div class="card-body">
                                    <p class="card-text" style="font-style: italic;text-align: center;">
                                        Esta sección muestra <b>solamente las boletas del sistema privado del último período </b> presentes en el archivo Excel. Para un correcto funcionamiento <u>baja el Excel y cargalo después del día 15 del mes</u>.
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div> 
                 <div class="container-fluid mt-4">
                    <!-- Contenedor para las tarjetas principales -->
                    <div id="tarjetasPrincipalesContainer">
                        @await Html.PartialAsync("_TarjetasPrincipales", Model)
                    </div>

                    <!-- Contenedor para los gráficos de boletas -->
                    <div id="graficosBoletasContainer">
                        @await Html.PartialAsync("_GraficosBoletas", Model)
                    </div>

                    <!-- Contenedor para las tarjetas de ingresos -->
                    <div id="tarjetasIngresosContainer">
                        @await Html.PartialAsync("_TarjetasIngresos", Model)
                    </div>

                    <!-- Contenedor para los gráficos de ingresos -->
                    <div id="graficosIngresosContainer">
                        @await Html.PartialAsync("_GraficosIngresos", Model)
                    </div>

                    <!-- Contenedor para la tabla de cirujanos -->
                    <div id="tablaCirujanosContainer">
                        @await Html.PartialAsync("_TablaCirujanos", Model)
                    </div>

                    <!-- Contenedor para el gráfico de hospitales -->
                    <div id="graficoHospitalesContainer">
                        @await Html.PartialAsync("_GraficoHospitales", Model)
                    </div>

                    <!-- Contenedor para la tabla de saldos mensuales -->
                    <div id="tablaSaldosMensualesContainer">
                        @await Html.PartialAsync("_TablaSaldosMensuales", Model)
                    </div>

                    <!-- Contenedor para el gráfico de montos a cobrar -->
                    <div id="graficoMontosCobrarContainer">
                        @await Html.PartialAsync("_GraficoMontosCobrar", Model)
                    </div>
                </div>     

            </div>
        </div>
        }

        <!-- Tab 5: Boletas -->
        <div class="tab-content" id="tab-5">
            <h2>Detalle Boletas</h2>
                <div class="container-fluid mt-4">
                    <div class="row">
                        <div class="col-lg-12 col-md-12 mb-4">
                                <h3 class="mb-4">Boletas del Archivo</h3>
                                <div class="table-responsive">
                                    <table id="tablaBoletasDelArchivo" class="table table-bordered table-hover align-middle display nowrap" style="width:100%">
                                        <thead class="table-light">
                                            <tr>
                                                 <th>Número Boleta</th>
                                                 <th>Fecha</th>
                                                 <th>Periodo</th>
                                                 <th>Mutual</th>
                                                 <th>Hospital</th>
                                                 <th>Cirujano</th>
                                                 <th>Facturado</th>
                                                 <th>Cobrado</th>
                                                 <th>Debitado</th>                                                
                                            </tr>
                                        </thead>
                                        <tbody>
                                            @foreach (var item in Model.ListadoBoletas.OrderByDescending(s => DateTime.Parse(s.Periodo)).ToList())
                                            {
                                                <tr>
                                                    <td>@item.NumeroBoleta</td>
                                                    <td>@item.Fecha.ToShortDateString()</td>
                                                    <td>@item.PeriodoAnio - @item.PeriodoMes</td>
                                                    <td>@item.EntidadCodigo - @item.EntidadTexto</td>
                                                    <td>@item.Hospital</td>
                                                    <td>@item.Cirujano</td>
                                                    <td>@String.Format(new System.Globalization.CultureInfo("es-AR"),"{0:C}", item.Facturado)</td>
                                                    <td>@String.Format(new System.Globalization.CultureInfo("es-AR"),"{0:C}", item.Debitado)</td>
                                                    <td>@String.Format(new System.Globalization.CultureInfo("es-AR"),"{0:C}", item.Cobrado)</td>
                                                </tr>
                                            }
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                    </div>
                </div>
        </div>
    </div>
</div>


}


@section Scripts
{


    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>

    <!-- Bootstrap -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- SignalR -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/5.0.9/signalr.min.js"></script>

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js">
        </script>

        <!-- Canva.js -->
        <script src="https://canvasjs.com/assets/script/canvasjs.min.js"></script>


        <!-- DataTables CSS -->
        <link rel="stylesheet" href="https://cdn.datatables.net/1.13.4/css/jquery.dataTables.min.css">

        <!-- DataTables JS -->
        <script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>

        <!-- DataTables Buttons (para exportación) -->
        <link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.3.6/css/buttons.dataTables.min.css">
        <script src="https://cdn.datatables.net/buttons/2.3.6/js/dataTables.buttons.min.js"></script>
        <script src="https://cdn.datatables.net/buttons/2.3.6/js/buttons.html5.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.3/jszip.min.js"></script>

        

        @if(Model.CantidadBoletasDia != null)
        {
        <!--Grafico Distribución de boletas por dia -->
        <script type="text/javascript">

            var cantidadBoletasDia = @Html.Raw(Json.Serialize(Model.CantidadBoletasDia));

            var labels = Object.keys(cantidadBoletasDia); // Claves del diccionario (días)
            var data = Object.values(cantidadBoletasDia); // Valores del diccionario (cantidad de boletas)

            var ctx = document.getElementById('graficoBoletas').getContext('2d');
            var graficoBoletas = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels, // Usar las claves como etiquetas
                    datasets: [{
                        label: 'Cantidad de Boletas',
                        data: data, // Usar los valores correspondientes
                        backgroundColor: 'rgba(75, 192, 75, 0.6)',
                        borderColor: 'rgba(75, 192, 75, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        </script>
        }

        @if(Model.CantidadBoletasDiaPublico != null || Model.CantidadBoletasDiaPrivado != null)
        {
        <!--Grafico Distribución de boletas por dia último periodo -->
        <script type="text/javascript">
    // Datos de boletas del sector público
    var cantidadBoletasDiaPublico = @Html.Raw(Json.Serialize(Model.CantidadBoletasDiaPublico));
    var cantidadBoletasDiaPrivado = @Html.Raw(Json.Serialize(Model.CantidadBoletasDiaPrivado));

    var datasets = [];
    var labels = [];

    if (cantidadBoletasDiaPublico) {
        var labelsPublico = Object.keys(cantidadBoletasDiaPublico);
        labels = [...new Set([...labels, ...labelsPublico])];
        var dataPublico = labels.map(function(day) {
            return cantidadBoletasDiaPublico[day] || 0;
        });
        datasets.push({
            label: 'Boletas Públicas',
            data: dataPublico,
            backgroundColor: 'rgba(0, 123, 255, 0.6)',
            borderColor: '#007BFF',
            borderWidth: 1
        });
    }

    if (cantidadBoletasDiaPrivado) {
        var labelsPrivado = Object.keys(cantidadBoletasDiaPrivado);
        labels = [...new Set([...labels, ...labelsPrivado])];
        var dataPrivado = labels.map(function(day) {
            return cantidadBoletasDiaPrivado[day] || 0;
        });
        datasets.push({
            label: 'Boletas Privadas',
            data: dataPrivado,
            backgroundColor: 'rgba(75, 192, 75, 0.6)',
            borderColor: 'rgba(75, 192, 75, 1)',
            borderWidth: 1
        });
    }


    var ctx = document.getElementById('graficoBoletaslastperiod').getContext('2d');
    var graficoBoletasCombinado = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: datasets
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                x: {
                    stacked: true
                },
                y: {
                    stacked: true,
                    beginAtZero: true
                }
            },
            plugins: {
                tooltip: {
                    callbacks: {
                        label: function(tooltipItem) {
                            var label = tooltipItem.dataset.label || '';
                            var value = tooltipItem.raw;
                            return label + ': ' + value.toLocaleString();
                        }
                    }
                },
                legend: {
                    display: true,
                    position: 'top'
                }
            }
        }
    });
        </script>
        }

        @if(Model.CantidadBoletasDiaPublico != null)
        {
        <!--Grafico Distribución de boletas por dia último periodo público -->
        <script type="text/javascript">

            var cantidadBoletasDia = @Html.Raw(Json.Serialize(Model.CantidadBoletasDiaPublico));

            var labels = Object.keys(cantidadBoletasDia); // Claves del diccionario (días)
            var data = Object.values(cantidadBoletasDia); // Valores del diccionario (cantidad de boletas)

            var ctx = document.getElementById('graficoBoletasPublico').getContext('2d');
            var graficoBoletas = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels, // Usar las claves como etiquetas
                    datasets: [{
                        label: 'Cantidad de Boletas',
                        data: data, // Usar los valores correspondientes
                        backgroundColor: '#007BFF',
                        borderColor: '#007BFF',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        </script>
        }

        @if(Model.CantidadBoletasDiaPrivado != null)
        {
        <!--Grafico Distribución de boletas por dia último periodo privado -->
        <script type="text/javascript">

            var cantidadBoletasDia = @Html.Raw(Json.Serialize(Model.CantidadBoletasDiaPrivado));

            var labels = Object.keys(cantidadBoletasDia); // Claves del diccionario (días)
            var data = Object.values(cantidadBoletasDia); // Valores del diccionario (cantidad de boletas)

            var ctx = document.getElementById('graficoBoletasPrivado').getContext('2d');
            var graficoBoletas = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels, // Usar las claves como etiquetas
                    datasets: [{
                        label: 'Cantidad de Boletas',
                        data: data, // Usar los valores correspondientes
                        backgroundColor: 'rgba(75, 192, 75, 0.6)',
                        borderColor: 'rgba(75, 192, 75, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        </script>
        }

        @if(Model.IngresosMensualesPublico != null)
        {
        <!--Grafico Ingresos publicos-->
        <script type="text/javascript">
            // Formatear los periodos en formato "YYYY - MM"
            var periodos = @Html.Raw(Json.Serialize(Model.IngresosMensualesPublico.Keys.TakeLast(12).Select(p => p.ToString("yyyy - MM"))));
            var ingresos = @Html.Raw(Json.Serialize(Model.IngresosMensualesPublico.Values.TakeLast(12)));

            // Configurar el gráfico
            var ctx = document.getElementById('graficoIngresos').getContext('2d');
            var graficoIngresos = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: periodos, // Eje X: Periodos (meses formateados como YYYY - MM)
                    datasets: [{
                        label: 'Facturación mensual',
                        data: ingresos, // Eje Y: Ingresos
                        backgroundColor: 'rgba(54, 162, 235, 0.2)',
                        borderColor: 'rgba(54, 162, 235, 1)',
                        borderWidth: 2,
                        fill: true, // Para llenar el área debajo de la línea
                        tension: 0.1 // Suavizado de la curva
                    }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Periodo (Meses)'
                            }
                        },
                        y: {
                            beginAtZero: false, // No comenzar desde cero para que los montos se ajusten mejor
                            title: {
                                display: true,
                                text: 'Monto (Ingresos)'
                            },
                            ticks: {
                                callback: function (value, index, values) {
                                    return '$' + value.toLocaleString();
                                }
                            }
                        }
                    },
                    plugins: {
                         title: {
                            display: true,
                            text: 'Evolución de la facturación mensual (Últimos 12 meses)', // El título del gráfico
                            font: {
                                size: 18 // Tamaño de la fuente
                            },
                            padding: {
                                top: 10,
                                bottom: 30
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function (context) {
                                    // Mostrar el valor con el símbolo de $ en el tooltip
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    label += '$' + context.raw.toLocaleString(); // Formatear el valor con $
                                    return label;
                                }
                            }
                        }
                    }
                }

            });
        </script>
        }

        @if(Model.CantidadBoletasMensualesPublico != null)
        {
        <!--Grafico Cantidad de boletas por mes publicas-->
        <script type="text/javascript">
            // Formatear los periodos en formato "YYYY - MM"
            var valorX = @Html.Raw(Json.Serialize(Model.CantidadBoletasMensualesPublico.Keys.Select(p => p.ToString("yyyy - MM"))));
            var valorY = @Html.Raw(Json.Serialize(Model.CantidadBoletasMensualesPublico.Values));

            // Configurar el gráfico
            var ctx = document.getElementById('graficoCantidadMesPublicas').getContext('2d');
            var graficoIngresos = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: valorX, // Eje X: Periodos (meses formateados como YYYY - MM)
                    datasets: [{
                        label: 'Cantidad de boletas mensuales',
                        data: valorY, // Eje Y: Ingresos
                        backgroundColor: 'rgba(54, 162, 235, 0.2)',
                        borderColor: 'rgba(54, 162, 235, 1)',
                        borderWidth: 2,
                        fill: true, // Para llenar el área debajo de la línea
                        tension: 0.1 // Suavizado de la curva
                    }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Evolución de la cantidad de boletas mensuales (Últimos 12 meses)', // El título del gráfico
                            font: {
                                size: 18 // Tamaño de la fuente
                            },
                            padding: {
                                top: 10,
                                bottom: 30
                            }
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Periodo (Meses)'
                            }
                        },
                        y: {
                            beginAtZero: false, // No comenzar desde cero para que los montos se ajusten mejor
                            title: {
                                display: true,
                                text: 'Cantidad de Boletas'
                            }
                        }
                    }
                }

            });
        </script>
        }


        <!-- Tabla Saldos Mensuales Publicos -->
        <script type="text/javascript">
        document.addEventListener("DOMContentLoaded", function () {
                    const tabs = document.querySelectorAll(".tab");
                    const contents = document.querySelectorAll(".tab-content");

                    tabs.forEach(tab => {
                        tab.addEventListener("click", function () {
                            // Remover la clase activa de todas las pestañas y contenidos
                            tabs.forEach(t => t.classList.remove("active"));
                            contents.forEach(c => c.classList.remove("active"));

                            // Añadir la clase activa a la pestaña y contenido seleccionados
                            this.classList.add("active");
                            const activeTabContent = document.querySelector(`#${this.dataset.tab}`);
                            activeTabContent.classList.add("active");
                        });
                    });
                });
            
                    $(document).ready(function () {
                        $('#tablaSaldosMensualesPublicos').DataTable({
                            paging: true, // Habilitar paginación
                            pageLength: 12, // Mostrar 12 registros por página
                            lengthChange: true, // Permitir al usuario cambiar la cantidad de registros
                            searching: true, // Habilitar búsqueda
                            ordering: true, // Permitir ordenar columnas
                            info: true, // Mostrar información del número de registros
                            autoWidth: false, // Auto-ajuste de ancho de columnas
                            responsive: true, // Habilitar responsividad
                            dom: 'Bfrtip', // Elementos a incluir (B=botones, f=buscador, r=progreso, t=tabla, i=información, p=paginación)
                            buttons: [
                                'copy', 'csv', 'excel', 'pdf' // Botones de exportación
                            ],
                            order: [], // Desactiva el orden automático
                            language: {
                                url: 'https://cdn.datatables.net/plug-ins/2.1.8/i18n/es-ES.json' // Cargar traducción en español
                            }
                        });
                
                $('#tablaSaldosMensualesPrivados').DataTable({
                    paging: true, // Habilitar paginación
                    pageLength: 12, // Mostrar 12 registros por página
                    lengthChange: true, // Permitir al usuario cambiar la cantidad de registros
                    searching: true, // Habilitar búsqueda
                    ordering: true, // Permitir ordenar columnas
                    info: true, // Mostrar información del número de registros
                    autoWidth: false, // Auto-ajuste de ancho de columnas
                    responsive: true, // Habilitar responsividad
                    dom: 'Bfrtip', // Elementos a incluir (B=botones, f=buscador, r=progreso, t=tabla, i=información, p=paginación)
                    buttons: [
                        'copy', 'csv', 'excel', 'pdf' // Botones de exportación
                    ],
                    order: [], // Desactiva el orden automático
                    language: {
                        url: 'https://cdn.datatables.net/plug-ins/2.1.8/i18n/es-ES.json' // Cargar traducción en español
                    }
                });

                $('#tablaBoletasDelArchivo').DataTable({
                    paging: true, // Habilitar paginación
                    pageLength: 50, // Mostrar 12 registros por página
                    lengthChange: true, // Permitir al usuario cambiar la cantidad de registros
                    searching: true, // Habilitar búsqueda
                    ordering: true, // Permitir ordenar columnas
                    info: true, // Mostrar información del número de registros
                    autoWidth: false, // Auto-ajuste de ancho de columnas
                    responsive: true, // Habilitar responsividad
                    dom: 'Bfrtip', // Elementos a incluir (B=botones, f=buscador, r=progreso, t=tabla, i=información, p=paginación)
                    buttons: [
                        'copy', 'csv', 'excel', 'pdf' // Botones de exportación
                    ],
                    order: [], // Desactiva el orden automático
                    language: {
                        url: 'https://cdn.datatables.net/plug-ins/2.1.8/i18n/es-ES.json' // Cargar traducción en español
                    }
                });

                $('#tablaCirujanos').DataTable({
                    paging: true, // Habilitar paginación
                    pageLength: 10, // Mostrar 12 registros por página
                    lengthChange: true, // Permitir al usuario cambiar la cantidad de registros
                    searching: true, // Habilitar búsqueda
                    ordering: true, // Permitir ordenar columnas
                    info: true, // Mostrar información del número de registros
                    autoWidth: false, // Auto-ajuste de ancho de columnas
                    responsive: true, // Habilitar responsividad
                    dom: 'Bfrtip', // Elementos a incluir (B=botones, f=buscador, r=progreso, t=tabla, i=información, p=paginación)
                    buttons: [
                        'copy', 'csv', 'excel', 'pdf' // Botones de exportación
                    ],
                    order: [], // Desactiva el orden automático
                    language: {
                        url: 'https://cdn.datatables.net/plug-ins/2.1.8/i18n/es-ES.json' // Cargar traducción en español
                    }
                });
                

            });
        </script>

        @if(Model.CantidadBoletasPorMutualPublico != null)
        {
        <!--Grafico de tortas Cantidad de Boletas por Mutual -->
          <script type="text/javascript">
    // Obtener las entidades y las cantidades de boletas
    var entidades = @Html.Raw(Json.Serialize(Model.CantidadBoletasPorMutualPublico.Keys));
    var cantidades = @Html.Raw(Json.Serialize(Model.CantidadBoletasPorMutualPublico.Values));

    // Calcular el total de boletas
    var total = cantidades.reduce((a, b) => a + b, 0);

    // Configurar el gráfico de torta con Chart.js
    var ctx = document.getElementById('graficoMutuales').getContext('2d');
    
    var chart = new Chart(ctx, {
        type: 'pie',
        data: {
            labels: entidades, // Etiquetas de las entidades
            datasets: [{
                label: 'Cantidad de boletas',
                data: cantidades, // Valores correspondientes a las boletas
                backgroundColor: [
                    'rgba(54, 162, 235, 0.6)',
                    'rgba(255, 99, 132, 0.6)',
                    'rgba(255, 205, 86, 0.6)',
                    'rgba(75, 192, 192, 0.6)',
                    'rgba(153, 102, 255, 0.6)',
                    'rgba(255, 159, 64, 0.6)'
                ],
                borderColor: [
                    'rgba(54, 162, 235, 1)',
                    'rgba(255, 99, 132, 1)',
                    'rgba(255, 205, 86, 1)',
                    'rgba(75, 192, 192, 1)',
                    'rgba(153, 102, 255, 1)',
                    'rgba(255, 159, 64, 1)'
                ],
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'left',
                     // Leyenda en la parte superior
                },
                tooltip: {
                    callbacks: {
                        label: function(tooltipItem) {
                           var dataset = tooltipItem.chart.data.datasets[0]; // Obtener el dataset
                            var value = dataset.data[tooltipItem.dataIndex]; // Obtener el valor correcto usando el índice
                            var total = dataset.data.reduce((a, b) => a + b, 0); // Calcular el total de las boletas
                            var percentage = ((value / total) * 100).toFixed(2); // Calcular el porcentaje correcto

                            var label = tooltipItem.label || '';

                            // Devolver el texto del tooltip con cantidad y porcentaje en negrita
                            return `${label}: ${value} boletas (${percentage}%)`;
                        }
                    }
                },
                title: {
                    display: true, // Mostrar el título
                    text: 'Cantidad de boletas por Mutual (Último período @Model.LastYear - @Model.LastPeriod)', // Texto del título
                    font: {
                        size: 20 // Tamaño de la fuente del título
                    },
                    padding: {
                        top: 10,
                        bottom: 30
                    }
                }
            },
            onClick: function(e, elements) {
                if (elements.length > 0) {
                    var index = elements[0].index;
                    var dataset = chart.data.datasets[0];
                    
                    // "Explotar" la porción haciendo que su tamaño aumente temporalmente
                    if (!dataset._meta) {
                        dataset._meta = Array(dataset.data.length).fill(false);
                    }
                    dataset._meta[index] = !dataset._meta[index];
                    dataset.borderWidth = dataset._meta.map(v => v ? 4 : 1); // Aumentar borde si está explotada
                    chart.update();
                }
            }
        }
    });

    // Redibujar el gráfico cuando la ventana se redimensiona o al cargar
    window.addEventListener('resize', function() {
        chart.resize(); // Volver a renderizar el gráfico
    });

    // Redibujar el gráfico al cargar la página completamente
    window.addEventListener('load', function() {
        chart.resize();
    });
        </script>
        }
        @if(Model.MontosProximosACobrarPublico != null)
        {
        <!--Grafico flujos brutos proximos publicos-->
        <script type="text/javascript">
    // Obtener los períodos (X) y los montos por entidad (Y) del ViewModel
    var periodos = @Html.Raw(Json.Serialize(Model.MontosProximosACobrarPublico.Select(p => p.Periodo)));

    // Obtener las entidades y los montos por entidad
    var entidades = @Html.Raw(Json.Serialize(Model.MontosProximosACobrarPublico.SelectMany(p => p.MontosPorEntidad.Keys).Distinct()));
    var montosPorPeriodoYEntidad = @Html.Raw(Json.Serialize(Model.MontosProximosACobrarPublico.Select(p => p.MontosPorEntidad)));

    // Definir una paleta de colores suaves y variados (100 colores)
    var colorPalette = [
        '#FFB3BA', '#FFDFBA', '#FFFFBA', '#BAFFC9', '#BAE1FF', '#B5A6FF', '#FFD6A5', '#FF6F61', '#F9C7CF', '#FBE7C6',
        '#A6E4FF', '#C1E1C1', '#FFCFDF', '#FFC4C4', '#D4B1D4', '#EDE3D2', '#FFF3B0', '#B5BFD3', '#97B1A6', '#FFF1E6',
        '#FFD6E0', '#E4C1F9', '#FDFFB6', '#FFADAD', '#FFC3A0', '#FFDAC1', '#C9E4DE', '#CCD5AE', '#FAF0D7', '#CFBAF0',
        '#A7BED3', '#C9C9FF', '#FFDEDE', '#D1C6AD', '#FFC6FF', '#FFE699', '#B6EB7A', '#D2FFD2', '#D7FFFB', '#DADFF7',
        '#DACDFA', '#FCE2E2', '#EDE9FE', '#E6C6FF', '#FFC4B2', '#FFDD99', '#C3C1F3', '#BAA0FF', '#EEDFFF', '#B5EAD7',
        '#D5AAFF', '#F5FFC8', '#E2D1FF', '#F0EBFE', '#FFF4D8', '#D7E7A9', '#FFC2E1', '#E7EFFF', '#B0F7E4', '#D6FFEC',
        '#FFF7BA', '#FFDCBA', '#D6E3FF', '#C6F7FF', '#D9FFB5', '#D4EDFF', '#B5F7FF', '#FFE9D6', '#D1C6F7', '#FFD6F7',
        '#FFF5D1', '#E8D6FF', '#F9E1F7', '#FFEBB5', '#C7E2FF', '#FFCFBA', '#FAFFD6', '#C6E1FF', '#FFFAE1', '#E2FFED',
        '#FFE1FF', '#EDE6FE', '#F2FFBA', '#F9E2FF', '#FFD6FA', '#D1C3FF', '#FFD1D9', '#FAF5D1', '#FFE9D9', '#E7FFD9',
        '#D9FAFF', '#FFFAD6', '#FFE1D9', '#D9FFFA', '#E1FFF7', '#FFF7D1', '#FAFFE1', '#D6FFE9', '#FAFFF7', '#D9FFF7'
    ];

    // Crear los datasets (dataPoints) para cada entidad
    var datasets = [];
    entidades.forEach(function(entidad, index) {
        // Crear un arreglo de montos para la entidad correspondiente en cada período
        var dataPoints = periodos.map(function(periodo, periodoIndex) {
            return montosPorPeriodoYEntidad[periodoIndex][entidad] || 0; // Monto o 0 si no hay datos para esa entidad en ese período
        });

        // Verificar si la entidad tiene al menos un valor distinto de 0 en cualquier período
        var hasNonZeroValue = dataPoints.some(function(value) {
            return value > 0; // Si hay algún valor mayor que 0
        });

        // Solo añadir entidades que tienen al menos un valor distinto de 0
        if (hasNonZeroValue) {
            datasets.push({
                label: entidad,
                data: dataPoints,
                backgroundColor: colorPalette[index % colorPalette.length], // Asignar un color suave de la paleta
                borderColor: colorPalette[index % colorPalette.length],
                borderWidth: 1
            });
        }
    });

    // Crear el gráfico con Chart.js
    var ctx = document.getElementById('graficoMontosCobrar').getContext('2d');
    var chart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: periodos, // Eje X (períodos)
            datasets: datasets // Datos de montos por entidad
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                x: {
                    stacked: true, // Habilitar apilamiento en eje X
                    title: {
                        display: true,
                        text: 'Periodo (Mes y Año)'
                    }
                },
                y: {
                    stacked: true, // Habilitar apilamiento en eje Y
                    title: {
                        display: true,
                        text: 'Monto'
                    },
                    ticks: {
                        callback: function(value) {
                            return '$' + value.toLocaleString(); // Formato del eje Y para montos en dólares
                        }
                    }
                }
            },
            plugins: {
                tooltip: {
                    mode: 'index', // Mostrar tooltip en modo de índices apilados
                    intersect: false,
                    callbacks: {
                        label: function(tooltipItem) {
                            var label = tooltipItem.dataset.label || '';
                            var value = tooltipItem.raw;
                            // Mostrar solo valores distintos de 0
                            if (value > 0) {
                                return `${label}: $${value.toLocaleString()}`;
                            }
                            return null; // Si es 0, no mostrar nada
                        },
                        footer: function(tooltipItems) {
                            var sum = 0;
                            tooltipItems.forEach(function(tooltipItem) {
                                sum += tooltipItem.raw;
                            });
                            return 'Total: $' + sum.toLocaleString();
                        }
                    }
                },
                legend: {
                    display: true,
                    position: 'top',
                    onClick: function(e, legendItem) {
                        var index = legendItem.datasetIndex;
                        var chart = this.chart;
                        var meta = chart.getDatasetMeta(index);
                        meta.hidden = !meta.hidden; // Ocultar/mostrar el dataset
                        chart.update();
                    }
                },
                title: {
                    display: true,
                    text: '¿Cuánto va a entrar a mi cuenta en los próximos meses? (Bruto)', // Título del gráfico
                    font: {
                        size: 24
                    }
                }
            }
        }
    });

    // Redibujar el gráfico cuando la ventana se redimensiona o al cargar
    window.addEventListener('resize', function() {
        chart.resize(); // Volver a renderizar el gráfico
    });

    window.addEventListener('load', function() {
        chart.resize();
    });
        </script>
        }
        @if(Model.IngresosMensualesPublico != null || Model.IngresosMensualesPrivados != null)
        {
        <!--Grafico Ingresos mensuales historicos (publicos y privados)-->
        <script type="text/javascript">
            // Obtener los ingresos públicos y privados del ViewModel
            var ingresosPublicos = @Html.Raw(Json.Serialize(Model.IngresosMensualesPublico));
            var ingresosPrivados = @Html.Raw(Json.Serialize(Model.IngresosMensualesPrivados));

            var dataPointsPublicos = [];
            var dataPointsPrivados = [];

        // Verificar si hay datos de ingresos públicos y crear los puntos de datos
            if (ingresosPublicos && Object.keys(ingresosPublicos).length > 0) {
                dataPointsPublicos = Object.keys(ingresosPublicos).map(function(key) {
                    return {
                        x: new Date(key), // Convertir la clave (fecha) en objeto Date
                        y: ingresosPublicos[key] // Valor del ingreso
                    };
                });
            }

            // Verificar si hay datos de ingresos privados y crear los puntos de datos
            if (ingresosPrivados && Object.keys(ingresosPrivados).length > 0) {
                dataPointsPrivados = Object.keys(ingresosPrivados).map(function(key) {
                    return {
                        x: new Date(key), // Convertir la clave (fecha) en objeto Date
                        y: ingresosPrivados[key] // Valor del ingreso
                    };
                });
            }

            var datasets = [];

            if (dataPointsPublicos.length > 0) {
                datasets.push({
                    type: "spline", // Línea suave para los ingresos públicos
                    name: "Ingresos Públicos",
                    showInLegend: true,
                    yValueFormatString: "$#,##0.00",
                    dataPoints: dataPointsPublicos
                });
            }

            if (dataPointsPrivados.length > 0) {
                datasets.push({
                    type: "spline", // Línea suave para los ingresos privados
                    name: "Ingresos Privados",
                    showInLegend: true,
                    yValueFormatString: "$#,##0.00",
                    dataPoints: dataPointsPrivados
                });
            }

            // Configurar el gráfico con dos series: público y privado
            var chart = new CanvasJS.Chart("graficoFacturacionHistorica", {
                animationEnabled: true,
                theme: "light2", // Tema claro
                title: {
                    text: ""
                },
                axisX: {
                    valueFormatString: "YYYY-MM", // Formato de la fecha en el eje X
                    labelAngle: -45, // Girar las etiquetas para mejorar la legibilidad
                    title: "Fecha (Mes y Año)"
                },
                axisY: {
                    title: "Facturación ($)",
                    prefix: "$",
                    labelFormatter: function(e) {
                        return "$" + e.value.toLocaleString(); // Formato de los valores en el eje Y
                    }
                },
                toolTip: {
                    shared: true, // Mostrar las dos series en el tooltip
                    content: function(e) {
                        // Formatear la fecha en YYYY-MM
                        var fechaFormateada = e.entries[0].dataPoint.x.toLocaleDateString("es-ES", {
                            year: "numeric",
                            month: "2-digit"
                        }).replace("/", "-"); // Convertir la fecha a YYYY-MM


                        var content = "<strong>" + fechaFormateada + "</strong><br/>";
                        var total = 0;

                        // Recorrer las entradas del tooltip (para ambos datasets)
                        for (var i = 0; i < e.entries.length; i++) {
                            content += e.entries[i].dataSeries.name + ": $" + e.entries[i].dataPoint.y.toLocaleString() + "<br/>";
                            total += e.entries[i].dataPoint.y; // Sumar el valor de ambos ingresos
                        }

                        // Añadir el total al tooltip
                        content += "<strong>Total: $" + total.toLocaleString() + "</strong>";
                        return content;
                    }
                },
                legend: {
                    cursor: "pointer",
                    itemclick: function(e) {
                        // Mostrar/ocultar las series al hacer clic en la leyenda
                        if (typeof(e.dataSeries.visible) === "undefined" || e.dataSeries.visible) {
                            e.dataSeries.visible = false;
                        } else {
                            e.dataSeries.visible = true;
                        }
                        chart.render();
                    }
                },
                data: [{
                    type: "spline", // Línea suave para los ingresos públicos
                    name: "Ingresos Públicos",
                    showInLegend: true,
                    yValueFormatString: "$#,##0.00",
                    dataPoints: dataPointsPublicos
                },
                {
                    type: "spline", // Línea suave para los ingresos privados
                    name: "Ingresos Privados",
                    showInLegend: true,
                    yValueFormatString: "$#,##0.00",
                    dataPoints: dataPointsPrivados
                }]
            });

            // Renderizar el gráfico
            chart.render();
        </script>
        }

        @if(Model.IngresosTotalesUSD != null)
        {
        <!--Grafico Ingresos mensuales historicos en USD-->
        <script type="text/javascript">
    // Obtener los ingresos públicos y privados del ViewModel
    var ingresos = @Html.Raw(Json.Serialize(Model.IngresosTotalesUSD));
    var cotizaciones = @Html.Raw(Json.Serialize(Model.CotizacionesUSD));

    var dataPointsUSD = [];
    var dataPointsCotizaciones = [];

    // Verificar si hay datos de ingresos públicos y crear los puntos de datos
    if (ingresos && Object.keys(ingresos).length > 0) {
        dataPointsUSD = Object.keys(ingresos).map(function(key) {
            return {
                x: new Date(key), // Convertir la clave (fecha) en objeto Date
                y: ingresos[key] // Valor del ingreso
            };
        });
    }

    // Verificar si hay datos de cotizaciones y crear los puntos de datos
    if (cotizaciones && Object.keys(cotizaciones).length > 0) {
        dataPointsCotizaciones = Object.keys(cotizaciones).map(function(key) {
            return {
                x: new Date(key), // Convertir la clave (fecha) en objeto Date
                y: cotizaciones[key] // Valor de la cotización
            };
        });
    }

    var datasets = [];

    if (dataPointsUSD.length > 0) {
        datasets.push({
            type: "line", // Línea suave para los ingresos públicos
            name: "Ingresos Totales en USD",
            showInLegend: true,
            yValueFormatString: "$#,##0.00",
            lineColor: "#f25252", // Especificar el color de la línea
            markerColor: "#f25252", // Especificar el mismo color para los puntos
            dataPoints: dataPointsUSD
        });
    }

    // Configurar el gráfico con dos series: público y privado
    var chart = new CanvasJS.Chart("graficoFacturacionHistoricaUSD", {
        animationEnabled: true,
        theme: "light2", // Tema claro
        title: {
            text: ""
        },
        axisX: {
            valueFormatString: "YYYY-MM", // Formato de la fecha en el eje X
            labelAngle: -45, // Girar las etiquetas para mejorar la legibilidad
            title: "Fecha (Mes y Año)"
        },
        axisY: {
            title: "Facturación ($)",
            prefix: "$",
            labelFormatter: function(e) {
                return "$" + e.value.toLocaleString(); // Formato de los valores en el eje Y
            }
        },
        toolTip: {
            shared: true, // Mostrar las dos series en el tooltip
            content: function(e) {
                // Formatear la fecha en YYYY-MM
                var fechaFormateada = e.entries[0].dataPoint.x.toLocaleDateString("es-ES", {
                    year: "numeric",
                    month: "2-digit"
                }).replace("/", "-"); // Convertir la fecha a YYYY-MM

                var content = "<strong>" + fechaFormateada + "</strong><br/>";
                var total = 0;
                var cotizacionPeriodo = 0;

                // Recorrer las entradas del tooltip (para ambos datasets)
                for (var i = 0; i < e.entries.length; i++) {
                    content += e.entries[i].dataSeries.name + ": $" + e.entries[i].dataPoint.y.toLocaleString() + "<br/>";
                    total += e.entries[i].dataPoint.y; // Sumar el valor de ambos ingresos
                }

                // Buscar la cotización correspondiente en dataPointsCotizaciones
                for (var i = 0; i < dataPointsCotizaciones.length; i++) {
                    if (dataPointsCotizaciones[i].x.getTime() === e.entries[0].dataPoint.x.getTime()) {
                        cotizacionPeriodo = dataPointsCotizaciones[i].y;
                        break;
                    }
                }

                // Añadir el total al tooltip y la cotización del dólar
                content += "<strong>Cotización del dólar: $" + cotizacionPeriodo.toLocaleString() + "</strong>";
                return content;
            }
        },
        legend: {
            cursor: "pointer",
            itemclick: function(e) {
                // Mostrar/ocultar las series al hacer clic en la leyenda
                if (typeof(e.dataSeries.visible) === "undefined" || e.dataSeries.visible) {
                    e.dataSeries.visible = false;
                } else {
                    e.dataSeries.visible = true;
                }
                chart.render();
            }
        },
        data: datasets
    });

    // Renderizar el gráfico
    chart.render();
        </script>
        }
        @if(Model.EdadPacientes != null)
        {
        <!--Grafico de tortas por edad GENERAL-->
        <script type="text/javascript">
    // Obtener las edades (las claves del diccionario) y las cantidades de pacientes (los valores)
    var edades = @Html.Raw(Json.Serialize(Model.EdadPacientes.Keys));
    var cantidades = @Html.Raw(Json.Serialize(Model.EdadPacientes.Values));

    // Calcular el total de pacientes
    var totalPacientes = cantidades.reduce((a, b) => a + b, 0); // Suma total de pacientes

    // Crear los puntos de datos para CanvasJS
    var dataPoints = edades.map(function (edad, index) {
        return {
            y: cantidades[index], // Cantidad de pacientes en ese rango de edad
            label: edad, // Rango de edad (etiqueta)
            name: edad // Nombre que aparecerá en la leyenda
        };
    });

    // Configurar el gráfico de torta con CanvasJS y radio personalizado
    var chart = new CanvasJS.Chart("graficoEdadPacientes", {
            animationEnabled: true,
            theme: "light2", // Tema opcional
            title: {
            text: "Distribución de Pacientes por Edad", // Texto del título
            fontSize: 24, // Tamaño de la fuente del título
            fontColor: "#333", // Color de la fuente del título (opcional)
            padding: 10, // Espacio alrededor del título
            horizontalAlign: "center" // Alineación del título (center, left, right)
        },
        data: [{
            type: "pie",
            indexLabelFontSize: 18,
            radius: 80,
            indexLabel: "{label} - {y}",
            yValueFormatString: "#,##0 ", // Formato del valor en el gráfico
            click: explodePie,
            showInLegend: true,
            toolTipContent: "<b>{label}</b>: {y} pacientes (#percent%)", // Tooltip con porcentaje
            dataPoints: dataPoints // Los puntos de datos creados anteriormente
        }]
    });

    // Renderizar el gráfico
    chart.render();

    function explodePie(e) {
        for(var i = 0; i < e.dataSeries.dataPoints.length; i++) {
            if(i !== e.dataPointIndex)
                e.dataSeries.dataPoints[i].exploded = false;
        }
        e.dataSeries.dataPoints[e.dataPointIndex].exploded = !e.dataSeries.dataPoints[e.dataPointIndex].exploded;
    }

    // Redibujar el gráfico cuando la ventana se redimensiona o al cargar
    window.addEventListener('resize', function() {
        chart.render(); // Volver a renderizar el gráfico
    });

    // Redibujar el gráfico al cargar la página completamente
    window.addEventListener('load', function() {
        chart.render();
    });
        </script>
        }

        @if(Model.BoletasPorEntidadGeneral != null)
        {
        <!--Grafico de tortas por mutual GENERAL-->
        <script type="text/javascript">
    // Obtener las entidades y las cantidades de boletas
    var entidades = @Html.Raw(Json.Serialize(Model.BoletasPorEntidadGeneral.Keys));
    var cantidades = @Html.Raw(Json.Serialize(Model.BoletasPorEntidadGeneral.Values));

    // Calcular el total de boletas
    var total = cantidades.reduce((a, b) => a + b, 0);

    // Configurar el gráfico de torta con Chart.js
    var ctx = document.getElementById('graficosBoletasEntidadGeneral').getContext('2d');
    
    var chart = new Chart(ctx, {
        type: 'pie',
        data: {
            labels: entidades, // Etiquetas de las entidades
            datasets: [{
                label: 'Cantidad de boletas',
                data: cantidades, // Valores correspondientes a las boletas
                backgroundColor: [
                    'rgba(54, 162, 235, 0.6)',
                    'rgba(255, 99, 132, 0.6)',
                    'rgba(255, 205, 86, 0.6)',
                    'rgba(75, 192, 192, 0.6)',
                    'rgba(153, 102, 255, 0.6)',
                    'rgba(255, 159, 64, 0.6)'
                ],
                borderColor: [
                    'rgba(54, 162, 235, 1)',
                    'rgba(255, 99, 132, 1)',
                    'rgba(255, 205, 86, 1)',
                    'rgba(75, 192, 192, 1)',
                    'rgba(153, 102, 255, 1)',
                    'rgba(255, 159, 64, 1)'
                ],
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'left',
                     // Leyenda en la parte superior
                },
                tooltip: {
                    callbacks: {
                        label: function(tooltipItem) {
                           var dataset = tooltipItem.chart.data.datasets[0]; // Obtener el dataset
                            var value = dataset.data[tooltipItem.dataIndex]; // Obtener el valor correcto usando el índice
                            var total = dataset.data.reduce((a, b) => a + b, 0); // Calcular el total de las boletas
                            var percentage = ((value / total) * 100).toFixed(2); // Calcular el porcentaje correcto

                            var label = tooltipItem.label || '';

                            // Devolver el texto del tooltip con cantidad y porcentaje en negrita
                            return `${label}: ${value} boletas (${percentage}%)`;
                        }
                    }
                },
                title: {
                    display: true, // Mostrar el título
                    text: 'Cantidad de boletas por Mutual (Histórico)', // Texto del título
                    font: {
                        size: 20 // Tamaño de la fuente del título
                    },
                    padding: {
                        top: 10,
                        bottom: 30
                    }
                }
            },
            onClick: function(e, elements) {
                if (elements.length > 0) {
                    var index = elements[0].index;
                    var dataset = chart.data.datasets[0];
                    
                    // "Explotar" la porción haciendo que su tamaño aumente temporalmente
                    if (!dataset._meta) {
                        dataset._meta = Array(dataset.data.length).fill(false);
                    }
                    dataset._meta[index] = !dataset._meta[index];
                    dataset.borderWidth = dataset._meta.map(v => v ? 4 : 1); // Aumentar borde si está explotada
                    chart.update();
                }
            }
        }
    });

    // Redibujar el gráfico cuando la ventana se redimensiona o al cargar
    window.addEventListener('resize', function() {
        chart.resize(); // Volver a renderizar el gráfico
    });

    // Redibujar el gráfico al cargar la página completamente
    window.addEventListener('load', function() {
        chart.resize();
    });
        </script>
        }

        @if(Model.BoletasPorEntidadLastPeriod != null)
        {
        <!--Grafico de tortas por mutual LAST PERIOD-->
        <script type="text/javascript">
    // Obtener las entidades y las cantidades de boletas
    var entidades = @Html.Raw(Json.Serialize(Model.BoletasPorEntidadLastPeriod.Keys));
    var cantidades = @Html.Raw(Json.Serialize(Model.BoletasPorEntidadLastPeriod.Values));

    // Calcular el total de boletas
    var total = cantidades.reduce((a, b) => a + b, 0);

    // Configurar el gráfico de torta con Chart.js
    var ctx = document.getElementById('graficosBoletasEntidadLastPeriod').getContext('2d');
    
    var chart = new Chart(ctx, {
        type: 'pie',
        data: {
            labels: entidades, // Etiquetas de las entidades
            datasets: [{
                label: 'Cantidad de boletas',
                data: cantidades, // Valores correspondientes a las boletas
                backgroundColor: [
                    'rgba(54, 162, 235, 0.6)',
                    'rgba(255, 99, 132, 0.6)',
                    'rgba(255, 205, 86, 0.6)',
                    'rgba(75, 192, 192, 0.6)',
                    'rgba(153, 102, 255, 0.6)',
                    'rgba(255, 159, 64, 0.6)'
                ],
                borderColor: [
                    'rgba(54, 162, 235, 1)',
                    'rgba(255, 99, 132, 1)',
                    'rgba(255, 205, 86, 1)',
                    'rgba(75, 192, 192, 1)',
                    'rgba(153, 102, 255, 1)',
                    'rgba(255, 159, 64, 1)'
                ],
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'left',
                     // Leyenda en la parte superior
                },
                tooltip: {
                    callbacks: {
                        label: function(tooltipItem) {
                           var dataset = tooltipItem.chart.data.datasets[0]; // Obtener el dataset
                            var value = dataset.data[tooltipItem.dataIndex]; // Obtener el valor correcto usando el índice
                            var total = dataset.data.reduce((a, b) => a + b, 0); // Calcular el total de las boletas
                            var percentage = ((value / total) * 100).toFixed(2); // Calcular el porcentaje correcto

                            var label = tooltipItem.label || '';

                            // Devolver el texto del tooltip con cantidad y porcentaje en negrita
                            return `${label}: ${value} boletas (${percentage}%)`;
                        }
                    }
                },
                title: {
                    display: true, // Mostrar el título
                    text: 'Cantidad de boletas por Mutual (Último período @Model.LastYear - @Model.LastPeriod)', // Texto del título
                    font: {
                        size: 20 // Tamaño de la fuente del título
                    },
                    padding: {
                        top: 10,
                        bottom: 30
                    }
                }
            },
            onClick: function(e, elements) {
                if (elements.length > 0) {
                    var index = elements[0].index;
                    var dataset = chart.data.datasets[0];
                    
                    // "Explotar" la porción haciendo que su tamaño aumente temporalmente
                    if (!dataset._meta) {
                        dataset._meta = Array(dataset.data.length).fill(false);
                    }
                    dataset._meta[index] = !dataset._meta[index];
                    dataset.borderWidth = dataset._meta.map(v => v ? 4 : 1); // Aumentar borde si está explotada
                    chart.update();
                }
            }
        }
    });

    // Redibujar el gráfico cuando la ventana se redimensiona o al cargar
    window.addEventListener('resize', function() {
        chart.resize(); // Volver a renderizar el gráfico
    });

    // Redibujar el gráfico al cargar la página completamente
    window.addEventListener('load', function() {
        chart.resize();
    });
        </script>
        }

        @if(Model.IngresosMensualesPrivados != null)
        {
        <!--Grafico Ingresos Privados-->
        <script type="text/javascript">
            // Formatear los periodos en formato "YYYY - MM"
            var periodos = @Html.Raw(Json.Serialize(Model.IngresosMensualesPrivados.Keys.TakeLast(12).Select(p => p.ToString("yyyy - MM"))));
            var ingresos = @Html.Raw(Json.Serialize(Model.IngresosMensualesPrivados.Values.TakeLast(12)));

            // Configurar el gráfico
            var ctx = document.getElementById('graficoIngresosPrivados').getContext('2d');
            var graficoIngresos = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: periodos, // Eje X: Periodos (meses formateados como YYYY - MM)
                    datasets: [{
                        label: 'Facturación mensual',
                        data: ingresos, // Eje Y: Ingresos
                        backgroundColor: 'rgba(39, 174, 96, 0.2)',
                        borderColor: 'rgba(39, 174, 96, 1)',
                        borderWidth: 2,
                        fill: true, // Para llenar el área debajo de la línea
                        tension: 0.1 // Suavizado de la curva
                    }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Periodo (Meses)'
                            }
                        },
                        y: {
                            beginAtZero: false, // No comenzar desde cero para que los montos se ajusten mejor
                            title: {
                                display: true,
                                text: 'Monto (Ingresos)'
                            },
                            ticks: {
                                callback: function (value, index, values) {
                                    return '$' + value.toLocaleString();
                                }
                            }
                        }
                    },
                    plugins: {
                         title: {
                            display: true,
                            text: 'Evolución de la facturación mensual (Últimos 12 meses)', // El título del gráfico
                            font: {
                                size: 18 // Tamaño de la fuente
                            },
                            padding: {
                                top: 10,
                                bottom: 30
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function (context) {
                                    // Mostrar el valor con el símbolo de $ en el tooltip
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    label += '$' + context.raw.toLocaleString(); // Formatear el valor con $
                                    return label;
                                }
                            }
                        }
                    }
                }

            });
        </script>
        }
        @if(Model.CantidadBoletasMensualesPrivado != null)
        {
        <!--Grafico Cantidad de boletas por mes privadas-->
        <script type="text/javascript">
            // Formatear los periodos en formato "YYYY - MM"
            var valorX = @Html.Raw(Json.Serialize(Model.CantidadBoletasMensualesPrivado.Keys.Select(p => p.ToString("yyyy - MM"))));
            var valorY = @Html.Raw(Json.Serialize(Model.CantidadBoletasMensualesPrivado.Values));

            // Configurar el gráfico
            var ctx = document.getElementById('graficoCantidadMesPrivados').getContext('2d');
            var graficoIngresos = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: valorX, // Eje X: Periodos (meses formateados como YYYY - MM)
                    datasets: [{
                        label: 'Cantidad de boletas mensuales',
                        data: valorY, // Eje Y: Ingresos
                        backgroundColor: 'rgba(39, 174, 96, 0.2)',
                        borderColor: 'rgba(39, 174, 96, 1)',
                        borderWidth: 2,
                        fill: true, // Para llenar el área debajo de la línea
                        tension: 0.1 // Suavizado de la curva
                    }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Evolución de la cantidad de boletas mensuales (Últimos 12 meses)', // El título del gráfico
                            font: {
                                size: 18 // Tamaño de la fuente
                            },
                            padding: {
                                top: 10,
                                bottom: 30
                            }
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Periodo (Meses)'
                            }
                        },
                        y: {
                            beginAtZero: false, // No comenzar desde cero para que los montos se ajusten mejor
                            title: {
                                display: true,
                                text: 'Cantidad de Boletas'
                            }
                        }
                    }
                }

            });
        </script>
        }

        @if(Model.CantidadBoletasPorMutualPrivados != null)
        {
        <!--Grafico de tortas Cantidad de Boletas por Mutual -->
          <script type="text/javascript">
    // Obtener las entidades y las cantidades de boletas
    var entidades = @Html.Raw(Json.Serialize(Model.CantidadBoletasPorMutualPrivados.Keys));
    var cantidades = @Html.Raw(Json.Serialize(Model.CantidadBoletasPorMutualPrivados.Values));

    // Calcular el total de boletas
    var total = cantidades.reduce((a, b) => a + b, 0);

    // Configurar el gráfico de torta con Chart.js
    var ctx = document.getElementById('graficoMutualesPrivados').getContext('2d');
    
    var chart = new Chart(ctx, {
        type: 'pie',
        data: {
            labels: entidades, // Etiquetas de las entidades
            datasets: [{
                label: 'Cantidad de boletas',
                data: cantidades, // Valores correspondientes a las boletas
                backgroundColor: [
                    'rgba(54, 162, 235, 0.6)',
                    'rgba(255, 99, 132, 0.6)',
                    'rgba(255, 205, 86, 0.6)',
                    'rgba(75, 192, 192, 0.6)',
                    'rgba(153, 102, 255, 0.6)',
                    'rgba(255, 159, 64, 0.6)'
                ],
                borderColor: [
                    'rgba(54, 162, 235, 1)',
                    'rgba(255, 99, 132, 1)',
                    'rgba(255, 205, 86, 1)',
                    'rgba(75, 192, 192, 1)',
                    'rgba(153, 102, 255, 1)',
                    'rgba(255, 159, 64, 1)'
                ],
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'left',
                     // Leyenda en la parte superior
                },
                tooltip: {
                    callbacks: {
                        label: function(tooltipItem) {
                           var dataset = tooltipItem.chart.data.datasets[0]; // Obtener el dataset
                            var value = dataset.data[tooltipItem.dataIndex]; // Obtener el valor correcto usando el índice
                            var total = dataset.data.reduce((a, b) => a + b, 0); // Calcular el total de las boletas
                            var percentage = ((value / total) * 100).toFixed(2); // Calcular el porcentaje correcto

                            var label = tooltipItem.label || '';

                            // Devolver el texto del tooltip con cantidad y porcentaje en negrita
                            return `${label}: ${value} boletas (${percentage}%)`;
                        }
                    }
                },
                title: {
                    display: true, // Mostrar el título
                    text: 'Cantidad de boletas por Mutual (Último período @Model.LastYear - @Model.LastPeriod)', // Texto del título
                    font: {
                        size: 20 // Tamaño de la fuente del título
                    },
                    padding: {
                        top: 10,
                        bottom: 30
                    }
                }
            },
            onClick: function(e, elements) {
                if (elements.length > 0) {
                    var index = elements[0].index;
                    var dataset = chart.data.datasets[0];
                    
                    // "Explotar" la porción haciendo que su tamaño aumente temporalmente
                    if (!dataset._meta) {
                        dataset._meta = Array(dataset.data.length).fill(false);
                    }
                    dataset._meta[index] = !dataset._meta[index];
                    dataset.borderWidth = dataset._meta.map(v => v ? 4 : 1); // Aumentar borde si está explotada
                    chart.update();
                }
            }
        }
    });

    // Redibujar el gráfico cuando la ventana se redimensiona o al cargar
    window.addEventListener('resize', function() {
        chart.resize(); // Volver a renderizar el gráfico
    });

    // Redibujar el gráfico al cargar la página completamente
    window.addEventListener('load', function() {
        chart.resize();
    });
        </script>
        }

        @if(Model.MontosProximosACobrarPrivado != null)
        {
        <!--Grafico flujos brutos proximos privados-->
        <script type="text/javascript">
    // Obtener los períodos (X) y los montos por entidad (Y) del ViewModel
    var periodos = @Html.Raw(Json.Serialize(Model.MontosProximosACobrarPrivado.Select(p => p.Periodo)));

    // Obtener las entidades y los montos por entidad
    var entidades = @Html.Raw(Json.Serialize(Model.MontosProximosACobrarPrivado.SelectMany(p => p.MontosPorEntidad.Keys).Distinct()));
    var montosPorPeriodoYEntidad = @Html.Raw(Json.Serialize(Model.MontosProximosACobrarPrivado.Select(p => p.MontosPorEntidad)));

    // Definir una paleta de colores suaves y variados (100 colores)
    var colorPalette = [
        '#FFB3BA', '#FFDFBA', '#FFFFBA', '#BAFFC9', '#BAE1FF', '#B5A6FF', '#FFD6A5', '#FF6F61', '#F9C7CF', '#FBE7C6',
        '#A6E4FF', '#C1E1C1', '#FFCFDF', '#FFC4C4', '#D4B1D4', '#EDE3D2', '#FFF3B0', '#B5BFD3', '#97B1A6', '#FFF1E6',
        '#FFD6E0', '#E4C1F9', '#FDFFB6', '#FFADAD', '#FFC3A0', '#FFDAC1', '#C9E4DE', '#CCD5AE', '#FAF0D7', '#CFBAF0',
        '#A7BED3', '#C9C9FF', '#FFDEDE', '#D1C6AD', '#FFC6FF', '#FFE699', '#B6EB7A', '#D2FFD2', '#D7FFFB', '#DADFF7',
        '#DACDFA', '#FCE2E2', '#EDE9FE', '#E6C6FF', '#FFC4B2', '#FFDD99', '#C3C1F3', '#BAA0FF', '#EEDFFF', '#B5EAD7',
        '#D5AAFF', '#F5FFC8', '#E2D1FF', '#F0EBFE', '#FFF4D8', '#D7E7A9', '#FFC2E1', '#E7EFFF', '#B0F7E4', '#D6FFEC',
        '#FFF7BA', '#FFDCBA', '#D6E3FF', '#C6F7FF', '#D9FFB5', '#D4EDFF', '#B5F7FF', '#FFE9D6', '#D1C6F7', '#FFD6F7',
        '#FFF5D1', '#E8D6FF', '#F9E1F7', '#FFEBB5', '#C7E2FF', '#FFCFBA', '#FAFFD6', '#C6E1FF', '#FFFAE1', '#E2FFED',
        '#FFE1FF', '#EDE6FE', '#F2FFBA', '#F9E2FF', '#FFD6FA', '#D1C3FF', '#FFD1D9', '#FAF5D1', '#FFE9D9', '#E7FFD9',
        '#D9FAFF', '#FFFAD6', '#FFE1D9', '#D9FFFA', '#E1FFF7', '#FFF7D1', '#FAFFE1', '#D6FFE9', '#FAFFF7', '#D9FFF7'
    ];

    // Crear los datasets (dataPoints) para cada entidad
    var datasets = [];
    entidades.forEach(function(entidad, index) {
        // Crear un arreglo de montos para la entidad correspondiente en cada período
        var dataPoints = periodos.map(function(periodo, periodoIndex) {
            return montosPorPeriodoYEntidad[periodoIndex][entidad] || 0; // Monto o 0 si no hay datos para esa entidad en ese período
        });

        // Verificar si la entidad tiene al menos un valor distinto de 0 en cualquier período
        var hasNonZeroValue = dataPoints.some(function(value) {
            return value > 0; // Si hay algún valor mayor que 0
        });

        // Solo añadir entidades que tienen al menos un valor distinto de 0
        if (hasNonZeroValue) {
            datasets.push({
                label: entidad,
                data: dataPoints,
                backgroundColor: colorPalette[index % colorPalette.length], // Asignar un color suave de la paleta
                borderColor: colorPalette[index % colorPalette.length],
                borderWidth: 1
            });
        }
    });

    // Crear el gráfico con Chart.js
    var ctx = document.getElementById('graficoMontosCobrarPrivado').getContext('2d');
    var chart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: periodos, // Eje X (períodos)
            datasets: datasets // Datos de montos por entidad
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                x: {
                    stacked: true, // Habilitar apilamiento en eje X
                    title: {
                        display: true,
                        text: 'Periodo (Mes y Año)'
                    }
                },
                y: {
                    stacked: true, // Habilitar apilamiento en eje Y
                    title: {
                        display: true,
                        text: 'Monto'
                    },
                    ticks: {
                        callback: function(value) {
                            return '$' + value.toLocaleString(); // Formato del eje Y para montos en dólares
                        }
                    }
                }
            },
            plugins: {
                tooltip: {
                    mode: 'index', // Mostrar tooltip en modo de índices apilados
                    intersect: false,
                    callbacks: {
                        label: function(tooltipItem) {
                            var label = tooltipItem.dataset.label || '';
                            var value = tooltipItem.raw;
                            // Mostrar solo valores distintos de 0
                            if (value > 0) {
                                return `${label}: $${value.toLocaleString()}`;
                            }
                            return null; // Si es 0, no mostrar nada
                        },
                        footer: function(tooltipItems) {
                            var sum = 0;
                            tooltipItems.forEach(function(tooltipItem) {
                                sum += tooltipItem.raw;
                            });
                            return 'Total: $' + sum.toLocaleString();
                        }
                    }
                },
                legend: {
                    display: true,
                    position: 'top',
                    onClick: function(e, legendItem) {
                        var index = legendItem.datasetIndex;
                        var chart = this.chart;
                        var meta = chart.getDatasetMeta(index);
                        meta.hidden = !meta.hidden; // Ocultar/mostrar el dataset
                        chart.update();
                    }
                },
                title: {
                    display: true,
                    text: '¿Cuánto va a entrar a mi cuenta en los próximos meses? (Bruto)', // Título del gráfico
                    font: {
                        size: 24
                    }
                }
            }
        }
    });

    // Redibujar el gráfico cuando la ventana se redimensiona o al cargar
    window.addEventListener('resize', function() {
        chart.resize(); // Volver a renderizar el gráfico
    });

    window.addEventListener('load', function() {
        chart.resize();
    });
        </script>
        }

        @if(Model.CantidadBoletasPorHospitalPrivados != null)
        {
        <!--Grafico de tortas Cantidad de Boletas por Hospital -->
        <script type="text/javascript">
    // Obtener las entidades y las cantidades de boletas
    var entidades = @Html.Raw(Json.Serialize(Model.CantidadBoletasPorHospitalPrivados.Keys));
    var cantidades = @Html.Raw(Json.Serialize(Model.CantidadBoletasPorHospitalPrivados.Values));

    // Calcular el total de boletas
    var total = cantidades.reduce((a, b) => a + b, 0);

    // Configurar el gráfico de torta con Chart.js
    var ctx = document.getElementById('graficoHospitalesPrivados').getContext('2d');
    
    var chart = new Chart(ctx, {
        type: 'pie',
        data: {
            labels: entidades, // Etiquetas de las entidades
            datasets: [{
                label: 'Cantidad de boletas',
                data: cantidades, // Valores correspondientes a las boletas
                backgroundColor: [
                    'rgba(54, 162, 235, 0.6)',
                    'rgba(255, 99, 132, 0.6)',
                    'rgba(255, 205, 86, 0.6)',
                    'rgba(75, 192, 192, 0.6)',
                    'rgba(153, 102, 255, 0.6)',
                    'rgba(255, 159, 64, 0.6)'
                ],
                borderColor: [
                    'rgba(54, 162, 235, 1)',
                    'rgba(255, 99, 132, 1)',
                    'rgba(255, 205, 86, 1)',
                    'rgba(75, 192, 192, 1)',
                    'rgba(153, 102, 255, 1)',
                    'rgba(255, 159, 64, 1)'
                ],
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'left',
                     // Leyenda en la parte superior
                },
                tooltip: {
                    callbacks: {
                        label: function(tooltipItem) {
                           var dataset = tooltipItem.chart.data.datasets[0]; // Obtener el dataset
                            var value = dataset.data[tooltipItem.dataIndex]; // Obtener el valor correcto usando el índice
                            var total = dataset.data.reduce((a, b) => a + b, 0); // Calcular el total de las boletas
                            var percentage = ((value / total) * 100).toFixed(2); // Calcular el porcentaje correcto

                            var label = tooltipItem.label || '';

                            // Devolver el texto del tooltip con cantidad y porcentaje en negrita
                            return `${label}: ${value} cirugias (${percentage}%)`;
                        }
                    }
                },
                title: {
                    display: true, // Mostrar el título
                    text: 'Cantidad de boletas por Hospital (Último período @Model.LastYear - @Model.LastPeriod)', // Texto del título
                    font: {
                        size: 20 // Tamaño de la fuente del título
                    },
                    padding: {
                        top: 10,
                        bottom: 30
                    }
                }
            },
            onClick: function(e, elements) {
                if (elements.length > 0) {
                    var index = elements[0].index;
                    var dataset = chart.data.datasets[0];
                    
                    // "Explotar" la porción haciendo que su tamaño aumente temporalmente
                    if (!dataset._meta) {
                        dataset._meta = Array(dataset.data.length).fill(false);
                    }
                    dataset._meta[index] = !dataset._meta[index];
                    dataset.borderWidth = dataset._meta.map(v => v ? 4 : 1); // Aumentar borde si está explotada
                    chart.update();
                }
            }
        }
    });

    // Redibujar el gráfico cuando la ventana se redimensiona o al cargar
    window.addEventListener('resize', function() {
        chart.resize(); // Volver a renderizar el gráfico
    });

    // Redibujar el gráfico al cargar la página completamente
    window.addEventListener('load', function() {
        chart.resize();
    });
        </script>
        }

        @if(Model.CantidadBoletasSemanalesPrivado != null)
        {
        <script type="text/javascript">
        var cantidadBoletasSemanalesPrivado = @Html.Raw(Json.Serialize(Model.CantidadBoletasSemanalesPrivado));

        // Extraer las etiquetas (semanas) y los valores (cantidad de boletas)
        var labels = Object.keys(cantidadBoletasSemanalesPrivado);  // Semanas
        var data = Object.values(cantidadBoletasSemanalesPrivado);  // Cantidad de boletas

        // Crear el gráfico de barras horizontales
        var ctx = document.getElementById('graficoBoletasSemanalesPrivado').getContext('2d');
        var chart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels, // Semanas (eje Y)
                datasets: [{
                    label: 'Cantidad de Boletas',
                    data: data, // Valores correspondientes a cada semana
                    backgroundColor: 'rgba(75, 192, 75, 0.6)',
                    borderColor: 'rgba(75, 192, 75, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                indexAxis: 'y', // Hace que las barras sean horizontales
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: {
                        beginAtZero: true, // Comenzar el eje X desde 0
                        title: {
                            display: true,
                            text: 'Cantidad de Boletas'
                        }
                    },
                    y: {
                        title: {
                            display: true,
                            text: 'Semanas'
                        }
                    }
                },
                plugins: {
                    legend: {
                        display: false // Ocultar la leyenda
                    },
                    title: {
                        display: true,
                        text: 'Cantidad de Boletas por Semana'
                    }
                }
            }
        });
        
        </script>
        }

      <script>
     document.addEventListener('DOMContentLoaded', () => {
            const periodSelector = document.getElementById('periodSelector');

            periodSelector.addEventListener('change', (event) => {
                const selectedPeriod = event.target.value;

                $.ajax({
                    url: '/Home/ActualizarVistasPorPeriodo', // Acción que retorna la vista parcial
                    type: 'POST',
                    data: { periodo: selectedPeriod }, // Parámetro enviado al servidor

                    success: function (resultado) {
                        $('#resultContainer').html(resultado);

                    },
                    error: function () {
                        alert('Ocurrió un error al cargar la vista parcial.');
                    }
                });
            });
        });
</script>



}


